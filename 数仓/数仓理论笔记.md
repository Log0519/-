# 维度建模

## 一、事实表和维度表

事实表分为维度外键和度量值  
事实表围绕业务过程设计，一行对应一个事件，例如下单、取消订单  
特点：细长，就是平常说的大表  

粒度：是指表中的一行数据表达的业务细节程度  

### 1、事务事实表：必有

保存各业务过程的原子操作事件，如下单，支付，取消订单等业务过程，一个业务过程对应一个事务事实表，有下单事务事实表，支付事务事实表。保存最细粒度的操作事件，提供最大限度的灵活性，支持更多需求。  
设计过程：选择业务过程，声明粒度，确认纬度，确认事实  
缺点：某些情况效率低  
    1、比如存量型指标，例如电商中的虚拟货币，有使用和获取两种情况，要建两张表，所以要对两张表聚合，需要区分加减情况，还要对两张表的全表聚合，逻辑复杂  
    2、多事务关联统计：例如统计最近30天，用户下单到支付的时间间隔的平均值。这样需要大表join大表的操作需要避免，效率低  

### 2、周期快照事实表：可有

周期性打快照，主要用于分析一些存量型（库存，余额），和状态型（空气温度，行驶速度）指标，他们通常是连续的，无法捕获变动的原子事务操作。同常是分区表，根据日期分区，例如一天一个分区，每天全量同步一份mysql中的一张表  
设计流程：确定粒度由采样周期和维度描述，确认事实，周期一般是每天，粒度例如每日-仓库-商品，事实由指标确定。尽量最细粒度。  
一行代表每天每个仓库中的每个商品的库存  

事实类型分为  
可加事实  
可以按照与事实表相关的所有维度进行累加，例如事务型事实表中的事实  

半可加事实  
只能按照与事实表相关的一部分维度进行相加，例如周期型快照事实表中的事实，不能按时间维度累加，每天的库存累加也没用意义  

不可加事实  
完全不具备可加性，例如比率型事实，不可加一般需要转化为可加，例如比率化为分子和分母  

### 3、累积快照事实表：可有

解决多事务关联统计指标  
基于一个业务流程中的多个业务过程联合处理构建的事实表，一个流程例如下单，支付，发货，确认收货的业务过程  
累积型快照事实表通常具有多个日期字段，每个日期字段对应业务流程中的一个关键业务过程（里程碑），主要用于分析业务过程之间的时间间隔等需求，例如前面的例子，可以避免两个事务表关联的操作。每一行数据要分几次写入  
设计流程与事务型事实表相似：  
选择业务过程：选择一个业务流程当中需要关联的多个业务过程  
声明粒度：尽量粒度最小  
确认纬度，  
确认事实  

## 二、纬度表设计：

1、维度属性尽可能丰富，可以支持更丰富的指标  
2、尽量不使用编码，而使用明确的名字说明，一般可以编码和文字共存，方便下游查看使用  
    3、尽量沉淀出通用的维度属性，有些维度属性的获取需要进行比较复杂的逻辑处理，例如需要通过多个字段拼接得到，为避免后续每次使用时的处理，可将这些维度属性沉淀到维度表中  

规范化设计，得到雪花模型，减少数据冗余，增强数据一致性，拆表  

反规范化设计，得到星型模型，减少join，提高查询性能。一般采用  

## 三、维度变化

保存维度数据的历史状态有两种方法  
    1、全量快照表  
    2、每天全量一份，优点是简单，缺点是浪费存储空间（常用）  
    3、拉链表，更高效的保存，记录每条信息的生命周期，一旦一条记录的生命周期结束，就重新开始一条新的记录，并把当前日期放入生效开始日期
